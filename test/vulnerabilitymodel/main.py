# -*- coding: utf-8 -*-
"""
Created on Thu Apr  4 11:17:51 2024

@author: Moayad
"""

#%% Load Dependencies
import sys
repoDir = 'C:/Users/Moayad/Documents/GitHub/stickModel'
sys.path.insert(1, f'{repoDir}')

from plotters import *
from vulnerability import *
from utils import *

import pandas as pd
import numpy as np
import os
import pip
import re
import matplotlib.pyplot as plt
import matplotlib.ticker as ticker

### Check if storeyloss is installed, if not, pip install it.
def import_or_install(package):
    try:
        __import__(package)
    except ImportError:
        pip.main(['install', package])
import_or_install('storeyloss')
import storeyloss

#%% User Input

buildingClasses = sorted_alphanumeric(os.listdir(f'{repoDir}/demo_run/analysis'))
buildingOccupancy = 'Res'
region = 'Region_1'
path_to_database = f'{repoDir}/metadata/quantities_v1.0.xlsx'
outDir = f'{repoDir}/demo_run/vulnerability_output'

for i, currentBuildingClass in enumerate(buildingClasses):
    
    mat = currentBuildingClass.split('_')[1]
    print(mat)
    
    ### Prepare input files
    df, df_psd, df_pfa = create_csv_from_database(path_to_database, mat, buildingOccupancy, region, outDir)
    
    ### Create storey loss functions
    path_to_input = [f'{outDir}/PSD_{region.lower()}_{mat.lower()}_{buildingOccupancy.lower()}.csv',
                     f'{outDir}/PFA_{region.lower()}_{mat.lower()}_{buildingOccupancy.lower()}.csv']
    psd_slf, psd_cache, pfa_slf, pfa_cache = create_slfs(path_to_input, rlz=200, repCost = 1.0, regF = 'Weibull')

    ### Plot some realisations
    plot_slf_rlz(psd_slf, psd_cache, pfa_slf, pfa_cache, rlz_to_consider = 5)


    ### 
    adsdsds

dsds
bldgClass = 'ADO'
bldgOccupancy = 'Res'
region = 'Region_1'
repoDir = 'C:/Users/Moayad/Documents/GitHub/stickModel/metadata'

path_to_input = [f'C:/Users/Moayad/Documents/GitHub/stickModel/metadata/output/PSD_{region.lower()}_{bldgClass.lower()}_{bldgOccupancy.lower()}.csv',
                 f'C:/Users/Moayad/Documents/GitHub/stickModel/metadata/output/PFA_{region.lower()}_{bldgClass.lower()}_{bldgOccupancy.lower()}.csv']

#%% Call the function to create slf-generator-compatible input files

df, df_psd, df_pfa = create_csv_from_database(path_to_database, bldgClass, bldgOccupancy, region, outDir)

#%% Call the function that creates normalised storey-loss functions

psd_slf, psd_cache, pfa_slf, pfa_cache = create_slfs(path_to_input, rlz=200, repCost = 1.0, regF = 'Weibull')

#%% Call the function to plot the realizations and the slfs by component category

plot_slf_rlz(psd_slf, psd_cache, pfa_slf, pfa_cache, rlz_to_consider = 5)

#%% Create the function that integrates ansys_dict and slfs

path_to_ansys_pkl = 'C:/Users/Moayad/Desktop/calibration/CR_LFINF+CDM+DUL_H1/CR_LFINF+CDM+DUL_H1.pkl'
path_to_ansys_ims = 'C:/Users/Moayad/Desktop/GEM/2024/WG North America Vulnerability/output/selected_gmrs_IMs.pkl'

vulnDict = create_vulnerability(path_to_ansys_pkl, path_to_ansys_ims, psd_slf, pfa_slf, collLimit = 0.1)

#%% Open Existing Vulnerabilities

vulnerability_existing_pga = pd.read_csv('C:/Users/Moayad/Downloads/nonstruct_vul_PGA_RES_.csv', header = None)
vulnerability_existing_sa03 = pd.read_csv('C:/Users/Moayad/Downloads/nonstruct_vul_SA(0.3s)_RES_.csv', header = None)
vulnerability_existing_sa06 = pd.read_csv('C:/Users/Moayad/Downloads/nonstruct_vul_SA(0.6s)_RES_.csv', header = None)

plt.plot(vulnerability_existing_pga[0].to_list(),vulnerability_existing_pga[1].to_list())
plt.plot(vulnDict['PGA'][:,0],vulnDict['PGA'][:,1])
plt.show()

plt.plot(vulnerability_existing_sa03[0].to_list(),vulnerability_existing_sa03[1].to_list())
plt.plot(vulnDict['SA06'][:,0],vulnDict['SA03'][:,1])
plt.show()

plt.plot(vulnerability_existing_sa06[0].to_list(),vulnerability_existing_sa06[1].to_list())
plt.plot(vulnDict['SA06'][:,0],vulnDict['SA06'][:,1])
plt.show()


#%% Change The Prices according to Porter et al. 2014
# (Guidelines for component-based analytical vulnerability assessment of buildings and nonstructural) GEM Technical Report elements )

if region == '1':
    economic_factor = 1.00
elif region == '2':
    params  = {'r_lab': 2.275,   # Ratio of hourly cost for European construction labor to the hourly cost for US construction labor
                'f_lab1': 0.9,    # For efforts requiring repairing but not replacing architectural and structural components, mechanical, electrical, or plumbing equipment
                'f_lab2': 0.5,    # For efforts requiring replacing architectural and structural components
                'f_lab3': 0.1}    # For efforts requiring replacing mechanical, electrical, and plumbing equipment
elif region == '3':
    params  = {'r_lab': 0.353,   # Ratio of hourly cost for South American construction labor to the hourly cost for US construction labor
                'f_lab1': 0.9,    # For efforts requiring repairing but not replacing architectural and structural components, mechanical, electrical, or plumbing equipment
                'f_lab2': 0.5,    # For efforts requiring replacing architectural and structural components
                'f_lab3': 0.1}    # For efforts requiring replacing mechanical, electrical, and plumbing equipment
elif region == '4':
    params =  {'r_lab': 0.470,   # Ratio of hourly cost for Asian and Middle-Eastern construction labor to the hourly cost for US construction labor
                'f_lab1': 0.9,    # For efforts requiring repairing but not replacing architectural and structural components, mechanical, electrical, or plumbing equipment
                'f_lab2': 0.5,    # For efforts requiring replacing architectural and structural components
                'f_lab3': 0.1}    # For efforts requiring replacing mechanical, electrical, and plumbing equipment
elif region == '5':
    params =  {'r_lab': 0.381,   # Ratio of hourly cost for African construction labor to the hourly cost for US construction labor
                'f_lab1': 0.9,    # For efforts requiring repairing but not replacing architectural and structural components, mechanical, electrical, or plumbing equipment
                'f_lab2': 0.5,    # For efforts requiring replacing architectural and structural components
                'f_lab3': 0.1}    # For efforts requiring replacing mechanical, electrical, and plumbing equipment    
    
    
    
